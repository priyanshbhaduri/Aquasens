/*
 * Copyright (C) 2024 Priyansh Bhaduri <priyanshbhaduriuni@gmail.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/*
 * AQUASENS - D1 Mini Code (Secondary Brain)
 * 
 * This code handles:
 * - Receiving sensor data from Arduino Mega via Serial
 * - Parsing the data string
 * - Connecting to WiFi
 * - Sending data to Blynk IoT platform
 * - Receiving commands from Blynk
 * - Controlling 4-channel relay module
 */

#define BLYNK_TEMPLATE_ID "YOUR_TEMPLATE_ID"
#define BLYNK_TEMPLATE_NAME "AQUASENS"
#define BLYNK_AUTH_TOKEN "YOUR_AUTH_TOKEN"

// Blynk Print for debugging
#define BLYNK_PRINT Serial

#include <ESP8266WiFi.h>
#include <BlynkSimpleEsp8266.h>

// WiFi credentials
char ssid[] = "YOUR_WIFI_SSID";
char pass[] = "YOUR_WIFI_PASSWORD";

// Blynk auth token
char auth[] = BLYNK_AUTH_TOKEN;

// Relay Pin Definitions (D1 Mini GPIO pins)
#define RELAY1_PIN D1  // Heating Rod
#define RELAY2_PIN D2  // Air Pump
#define RELAY3_PIN D5  // Filter
#define RELAY4_PIN D6  // Extra Equipment

// Virtual Pins for Blynk
#define VPIN_PH V0
#define VPIN_TDS V1
#define VPIN_TEMP V2
#define VPIN_DO V3
#define VPIN_RELAY1 V4
#define VPIN_RELAY2 V5
#define VPIN_RELAY3 V6
#define VPIN_RELAY4 V7

// Sensor values
float pH_value = 0.0;
float tds_value = 0.0;
float temp_value = 0.0;
float do_value = 0.0;

// Relay states
bool relay1_state = false;
bool relay2_state = false;
bool relay3_state = false;
bool relay4_state = false;

// Timer for sending data to Blynk
BlynkTimer timer;

void setup() {
  // Initialize Serial Communication
  Serial.begin(9600);
  delay(100);
  
  // Initialize Relay Pins
  pinMode(RELAY1_PIN, OUTPUT);
  pinMode(RELAY2_PIN, OUTPUT);
  pinMode(RELAY3_PIN, OUTPUT);
  pinMode(RELAY4_PIN, OUTPUT);
  
  // Turn off all relays initially (relay modules are usually active LOW)
  digitalWrite(RELAY1_PIN, HIGH);
  digitalWrite(RELAY2_PIN, HIGH);
  digitalWrite(RELAY3_PIN, HIGH);
  digitalWrite(RELAY4_PIN, HIGH);
  
  // Connect to WiFi and Blynk
  Serial.println("Connecting to WiFi...");
  Blynk.begin(auth, ssid, pass);
  
  // Setup timer to send data to Blynk every 2 seconds
  timer.setInterval(2000L, sendDataToBlynk);
  
  Serial.println("D1 Mini Ready!");
}

void loop() {
  Blynk.run();
  timer.run();
  
  // Read data from Arduino Mega
  if(Serial.available() > 0) {
    readDataFromMega();
  }
}

// Function to read and parse data from Arduino Mega
void readDataFromMega() {
  String data = Serial.readStringUntil('\n');
  data.trim();
  
  if(data.length() > 0) {
    // Parse the data string: "pH TDS Temperature DO"
    int firstSpace = data.indexOf(' ');
    int secondSpace = data.indexOf(' ', firstSpace + 1);
    int thirdSpace = data.indexOf(' ', secondSpace + 1);
    
    if(firstSpace > 0 && secondSpace > 0 && thirdSpace > 0) {
      pH_value = data.substring(0, firstSpace).toFloat();
      tds_value = data.substring(firstSpace + 1, secondSpace).toFloat();
      temp_value = data.substring(secondSpace + 1, thirdSpace).toFloat();
      do_value = data.substring(thirdSpace + 1).toFloat();
      
      // Debug print
      Serial.print("Received - pH:");
      Serial.print(pH_value);
      Serial.print(" TDS:");
      Serial.print(tds_value);
      Serial.print(" Temp:");
      Serial.print(temp_value);
      Serial.print(" DO:");
      Serial.println(do_value);
    }
  }
}

// Function to send data to Blynk
void sendDataToBlynk() {
  if(Blynk.connected()) {
    Blynk.virtualWrite(VPIN_PH, pH_value);
    Blynk.virtualWrite(VPIN_TDS, tds_value);
    Blynk.virtualWrite(VPIN_TEMP, temp_value);
    Blynk.virtualWrite(VPIN_DO, do_value);
    
    Serial.println("Data sent to Blynk");
  }
}

// Blynk Virtual Pin Handlers for Relay Control

// Relay 1 - Heating Rod
BLYNK_WRITE(VPIN_RELAY1) {
  int value = param.asInt();
  relay1_state = (value == 1);
  
  if(relay1_state) {
    digitalWrite(RELAY1_PIN, LOW);  // Turn ON (active LOW)
    Serial.println("Relay 1 (Heating Rod) ON");
  } else {
    digitalWrite(RELAY1_PIN, HIGH); // Turn OFF
    Serial.println("Relay 1 (Heating Rod) OFF");
  }
}

// Relay 2 - Air Pump
BLYNK_WRITE(VPIN_RELAY2) {
  int value = param.asInt();
  relay2_state = (value == 1);
  
  if(relay2_state) {
    digitalWrite(RELAY2_PIN, LOW);  // Turn ON (active LOW)
    Serial.println("Relay 2 (Air Pump) ON");
  } else {
    digitalWrite(RELAY2_PIN, HIGH); // Turn OFF
    Serial.println("Relay 2 (Air Pump) OFF");
  }
}

// Relay 3 - Filter
BLYNK_WRITE(VPIN_RELAY3) {
  int value = param.asInt();
  relay3_state = (value == 1);
  
  if(relay3_state) {
    digitalWrite(RELAY3_PIN, LOW);  // Turn ON (active LOW)
    Serial.println("Relay 3 (Filter) ON");
  } else {
    digitalWrite(RELAY3_PIN, HIGH); // Turn OFF
    Serial.println("Relay 3 (Filter) OFF");
  }
}

// Relay 4 - Extra Equipment
BLYNK_WRITE(VPIN_RELAY4) {
  int value = param.asInt();
  relay4_state = (value == 1);
  
  if(relay4_state) {
    digitalWrite(RELAY4_PIN, LOW);  // Turn ON (active LOW)
    Serial.println("Relay 4 (Extra Equipment) ON");
  } else {
    digitalWrite(RELAY4_PIN, HIGH); // Turn OFF
    Serial.println("Relay 4 (Extra Equipment) OFF");
  }
}

// Blynk connection status
BLYNK_CONNECTED() {
  Serial.println("Connected to Blynk!");
  
  // Sync relay states with Blynk app
  Blynk.syncVirtual(VPIN_RELAY1);
  Blynk.syncVirtual(VPIN_RELAY2);
  Blynk.syncVirtual(VPIN_RELAY3);
  Blynk.syncVirtual(VPIN_RELAY4);
}
